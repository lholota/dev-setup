## Fonts
- name: "Download Powerline fonts"
  win_get_url:
    url: https://github.com/powerline/fonts/archive/master.zip
    dest: "%TEMP%\\PowerlineFonts.zip"
    
- name: "Extract Powerline fonts"
  win_unzip:
    src: "%TEMP%\\PowerlineFonts.zip"
    dest: "%TEMP%"

- name: "Find font files"
  register: powerline_fonts
  win_find:
    paths: 
      - "{{ ansible_env.TEMP }}\\fonts-master"
    patterns: [ '*.otf', '*.ttf' ]
    recurse: yes

- name: "Copy fonts"
  win_copy:
    src: "{{ item.path }}"
    remote_src: yes
    dest: "%SYSTEMROOT%\\fonts\\{{ item.path | win_basename }}"
  loop: "{{ powerline_fonts.files }}"

- name: "Create registry entries"
  win_regedit:
    path: "HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Fonts"
    name: "{{ item.path | win_basename }}"
    data: "{{ item.path | win_basename }}"
  loop: "{{ powerline_fonts.files }}"

## Windows Terminal Options
- name: "Find Windows Terminal AppData Directory"
  register: terminal_appdata
  win_find:
    paths: "{{ ansible_env.LOCALAPPDATA }}\\Packages"
    patterns: "Microsoft.WindowsTerminal_*"
    file_type: "directory"

- name: Check if Windows Terminal settings file exists
  ansible.windows.win_stat:
    path: "{{ terminal_appdata.files[0].path }}\\LocalState\\settings.json"
  register: settings_file

- name: "Configure terminal appearance"
  when: settings_file.stat.exists
  win_lineinfile:
    path: "{{ terminal_appdata.files[0].path }}\\LocalState\\settings.json"
    line: '"fontFace": "Inconsolata-dz for Powerline","fontSize": 10,"colorScheme": "Campbell"'
    insertafter: ".*// Put settings here that you want to apply to all profiles.*"
    newline: unix

- name: "Warn if settings file does not exist"
  when: not settings_file.stat.exists
  debug:
    msg: |
      The Windows Terminal settings file could not found. Probably because you have not started Windows Terminal yet.
      Please make sure you select one of the Powerline fonts otherwise the glyphs will not be displayed properly.
      Or rerun this playbook which will set the font automatically.