- name: Install required packages
  ansible.builtin.apt:
    name: 
      - libpam-u2f
      - pamu2fcfg

- name: Check if user has an u2f key set up
  ansible.builtin.stat:
      path: /var/lib/mfa/{{ lookup('env', 'USER') }}/.u2f_keys
  register: u2f_keys

- name: Fail if the user has no u2f keys set up
  ansible.builtin.fail:
    msg: |
      Please do not forget to set save mapping of your u2f key to your profile with the following command:
      pamu2fcfg > /var/lib/mfa/{{ lookup('env', 'USER') }}/.u2f_keys
  when: not u2f_keys.stat.exists

- name: Create script for locking the screen when YubiKey is removed
  ansible.builtin.copy:
    dest: "/usr/local/bin/yubikey-removed-script"
    content: "{{ lookup('ansible.builtin.file', 'yubikey-removed-script') }}"
    owner: root
    group: root
    mode: 0775

- name: Create udev rule for locking the screen when YubiKey is removed
  ansible.builtin.copy:
    dest: "/etc/udev/rules.d/yubikey-screenlock.rules"
    content: "{{ lookup('ansible.builtin.file', 'yubikey-screenlock.rules') }}"
    owner: root
    group: root
    mode: 0664
