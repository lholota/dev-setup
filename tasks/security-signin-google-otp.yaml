- name: Install required packages
  ansible.builtin.apt:
    name: 
      - libpam-google-authenticator

- name: Check if user has an u2f key set up
  ansible.builtin.stat:
      path: /var/lib/mfa/{{ lookup('env', 'USER') }}/.google-authenticator
  register: google_otp

- name: Notify user to set up google authenticator
  ansible.builtin.fail:
    msg: |
      Please do not forget to set up google authenticator for your user account using the command below:
      google-authenticator --secret="/var/lib/mfa/{{ lookup('env', 'USER') }}/.google-authenticator
  when: not google_otp.stat.exists


# test if sufficient works with multiple factors or a substack is required

# - name: Add Google TOTP requirement for sign in
#   ansible.builtin.lineinfile:
#     path: /etc/pam.d/common-password
#     create: false
#     # Required for out-of-home secret storage
#     # null ok may be skipped depending on a variable
#     line: "auth sufficient pam_google_authenticator.so secret=/var/lib/mfa/${USER}/.google-authenticator nullok"
