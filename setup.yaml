- name: "Configure development workstation"
  hosts: localhost
  become: yes
  become_method: sudo
  become_user: root
  vars:
    nodejs_version: 20.x
    gpg_public_key_url: https://keybase.io/lholota/pgp_keys.asc
  handlers:
  - name: Update apt cache
    ansible.builtin.apt:
      update_cache: yes

  - name: Restart sshd
    ansible.builtin.service:
      name: sshd
      state: restarted
  tasks:
  - name: Gather the package facts
    ansible.builtin.package_facts:
      manager: auto
    tags: [ always ]

  - name: Load lsb-release for upstream ubuntu
    slurp:
      src: /etc/upstream-release/lsb-release
    register: ubuntu_lsb_release_file
    tags: [ always ]

  - name: Parse lsb-release into facts
    set_fact:
      ubuntu_lsb_release: "{{ ('{' + (ubuntu_lsb_release_file.content | b64decode).split('\n') | select | map('regex_replace', '([^=]*)=\"?([^\"]*)\"?', '\"\\1\": \"\\2\"') | join(',') + '}') | from_json }}"
    tags: [ always ]
      
  - name: Add third party repositories
    import_tasks: ./tasks/repos.yaml
    tags: [ always ]

  - name: Clean up pre-installed packages
    import_tasks: ./tasks/cleanup.yaml
    tags: [ cleanup ]

  - name: Install and configure Yubikey related tools
    import_tasks: ./tasks/security.yaml
    tags: [ security ]

  - name: Install and configure SSH
    import_tasks: ./tasks/ssh.yaml
    tags: [ ssh ]

  - name: Install standard tools and utils 
    import_tasks: ./tasks/utils.yaml
    tags: [ utils ]

  - name: Install development tools
    import_tasks: ./tasks/dev.yaml
    tags: [ dev, development ]

  - name: Install (dev)ops tools
    import_tasks: ./tasks/ops.yaml
    tags: [ ops ]