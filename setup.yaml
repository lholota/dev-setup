- name: "Configure development workstation"
  hosts: localhost
  become: yes
  become_method: sudo
  become_user: root
  handlers:
  - name: Update apt cache
    ansible.builtin.apt:
      update_cache: yes

  - name: Restart sshd
    ansible.builtin.service:
      name: sshd
      state: restarted
  tasks:
  - name: Gather the package facts
    ansible.builtin.package_facts:
      manager: auto
    tags: [ always ]

  - name: Load lsb-release for upstream ubuntu
    slurp:
      src: /etc/upstream-release/lsb-release
    register: ubuntu_lsb_release_file
    tags: [ always ]

  - name: Parse lsb-release into facts
    set_fact:
      ubuntu_lsb_release: "{{ ('{' + (ubuntu_lsb_release_file.content | b64decode).split('\n') | select | map('regex_replace', '([^=]*)=\"?([^\"]*)\"?', '\"\\1\": \"\\2\"') | join(',') + '}') | from_json }}"
    tags: [ always ]
      
  - name: Add third party repositories
    ansible.builtin.include_tasks:
      file: ./tasks/repos.yaml
    tags: [ always ]

  - name: Clean up pre-installed packages
    ansible.builtin.import_tasks:
      file: ./tasks/cleanup.yaml
    tags: [ cleanup ]

  - name: Install and configure security and yubikey related tools
    import_tasks: ./tasks/security.yaml
    tags: [ security ]

  - name: Install and configure crowdstrike falcon sensor
    import_tasks: ./tasks/crowdstrike.yaml
    tags: [ crowdstrike ]

  - name: Install and configure SSH
    import_tasks: ./tasks/ssh.yaml
    tags: [ ssh ]

  - name: Install firewall
    import_tasks: ./tasks/firewall.yaml
    tags: [ firewall ]

  - name: Install standard tools and utils 
    import_tasks: ./tasks/utils.yaml
    tags: [ utils ]

  - name: Install development tools
    import_tasks: ./tasks/dev.yaml
    tags: [ dev, development ]

  - name: Install (dev)ops tools
    import_tasks: ./tasks/ops.yaml
    tags: [ ops ]

  - name: Configure backups
    import_tasks: ./tasks/backup.yaml
    tags: [ backup ]
